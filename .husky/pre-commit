echo "🔍 Running lint-staged on changed files..."
npx lint-staged

# THIRD: Run type checks  
echo "🔧 Running type checks..."
if git diff --cached --name-only | grep -q "\.tsx\?$"; then
  if [ -f "backend/package.json" ] && npm list --depth=0 --workspace=backend >/dev/null 2>&1; then
    if git diff --cached --name-only | grep -q "^backend/.*\.tsx\?$"; then
      echo "  - Backend TypeScript files changed, running type-check..."
      npm run type-check --workspace=backend
    fi
    if git diff --cached --name-only | grep -q "^frontend/.*\.tsx\?$"; then
      echo "  - Frontend TypeScript files changed, running type-check..."
      npm run type-check --workspace=frontend --if-present
    fi
  else
    npm run type-check
  fi
fi

# FOURTH: Run tests
if git diff --cached --name-only | grep -q "\.(js|ts|jsx|tsx)$"; then
  echo "🧪 Running tests for changed files..."
  npm run test:staged --if-present
fi