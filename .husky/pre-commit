# FIRST: Check commit message if it exists
echo "💬 Checking commit message..."
if [ -f ".git/COMMIT_EDITMSG" ]; then
  npx --no-install commitlint --edit .git/COMMIT_EDITMSG
  if [ $? -ne 0 ]; then
    echo "❌ Fix your commit message first!"
    exit 1
  fi
  echo "✅ Commit message is valid"
fi

echo "🔍 Running lint-staged on changed files..."
npx lint-staged

echo "🔧 Running type checks..."
if git diff --cached --name-only | grep -q "\.tsx\?$"; then
  if [ -f "backend/package.json" ] && npm list --depth=0 --workspace=backend >/dev/null 2>&1; then
    if git diff --cached --name-only | grep -q "^backend/.*\.tsx\?$"; then
      echo "  - Backend TypeScript files changed, running type-check..."
      npm run type-check --workspace=backend
    fi
    if git diff --cached --name-only | grep -q "^frontend/.*\.tsx\?$"; then
      echo "  - Frontend TypeScript files changed, running type-check..."
      npm run type-check --workspace=frontend --if-present
    fi
  else
    npm run type-check
  fi
fi

echo "🧪 Running tests for changed files..."
if git diff --cached --name-only | grep -q "\.(js|ts|jsx|tsx)$"; then
  npm run test:staged --if-present
fi